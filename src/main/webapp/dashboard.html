<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Account Dashboard</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <h1 class="header">Sim ATM</h1>
        
        <div class="wrapper">
            <div class="account-menu">
                
                <a class="active" href="deposit">Deposit</a>
                <a href="withdrawal">Withdrawal</a>
                <a id="logoutLink" href="logout">Logout</a>
                
            </div>
            <div id="amount" class="form">
                
                <div id="accountBalance" style="font-size: 30px;"></div><br>
                
                <label for="inAmount">Amount: </label>
                <input id="inAmount" type=text>
                
                <span id="error" class="error"></span>
                <button id="confirmButton">Confirm</button>

            </div>
        </div>
        
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.1/moment.min.js"></script>
        <script>
            "use strict";
            
            let transactionType;
            let accountNumber;
            let email;
            let initBalance;
            
            $('.account-menu a').click(function (ev) {
                $('.account-menu a').each(function (i, elem) {
                    if ($(elem).hasClass('active')) {
                        $(elem).removeClass('active');
                        let href = $(elem).attr('href');
                        $('#' + href).hide();
                    }
                });
                let link = $(ev.target);
                link.addClass('active');
                transactionType = link.attr('href');
                return false;
            });
            
            $.ajax({
                url: 'api/dashboard',
                type: 'get',
                dataType: 'json',
                success: function (data) {
                        accountNumber = data.accountNumber;
                        email = data.email;
                        initBalance = data.balance;
                        $('#accountBalance').html("$" + Number(initBalance).toFixed(2));
                },
                error: function () {
                    alert('Error');
                }
            });
                
            $('#confirmButton').click(function () {
                let amount = parseFloat($('#inAmount').val());
                if(transactionType === 'withdrawal'){
                    if(!isValidWithdrawal(amount)){
                        $('#error').html("Invalid withdrawal");
                        return;
                    }
                    amount = amount * -1;
                }else{
                    if(!isValidDeposit(amount)){
                        $('#error').html("Invalid deposit");
                        return;
                    }
                }
                
                let balance = initBalance + amount;
                let data = JSON.stringify({
                    accountNumber: accountNumber,
                    email: email,
                    balance: balance
                });
                
                $.ajax({
                    url: 'api/dashboard',
                    type: 'put',
                    contentType: 'application/json',
                    data: data,
                    dataType: 'text',
                    success: function (resp) {
                        $('#inAmount').val('');
                        $('#error').html('');
                        if(resp < 20){
                            deleteAccount();
                        }
                        initBalance = parseFloat(resp);
                        $('#accountBalance').html("$" + Number(initBalance).toFixed(2));
                    },
                    error: function (resp) {
                        $('#error').html(resp.responseText);
                    }
                });
            });
            
            function deleteAccount(){
                $.ajax({
                    url: 'api/dashboard',
                    type: 'delete',
                    dataType: 'text',
                    success: function () {
                        window.location.replace("/sim-atm/");
                    },
                    error: function () {
                        alert('Error');
                    }
                });
            }
            
            $('#logoutLink').click(function () {
                $.ajax({
                    url: 'api/logout',
                    type: 'get',
                    dataType: 'text',
                    success: function () {
                        window.location.replace("/sim-atm/");
                    },
                    error: function () {
                        alert('Error');
                    }
                });
            });
            
            function isValidWithdrawal(withdrawal) {

                if (!(/^(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(withdrawal))) {
                    return false;
                }

                let withdrawalFloat = parseFloat(withdrawal);
                return (20 <= withdrawalFloat && withdrawalFloat <= 500) && (withdrawalFloat % 20 === 0) && (initBalance - withdrawalFloat >= 0);
            }
            
            function isValidDeposit(deposit) {

                if (!(/^(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/.test(deposit))) {
                    return false;
                }

                let depositFloat = parseFloat(deposit);
                return (5 <= depositFloat && depositFloat <= 10000) && (depositFloat % 1 === 0);
            }
            
        </script>
    </body>
</html>
